generator client {
    provider = "prisma-client"
    output   = "../generated/prisma"
}

datasource db {
    provider = "postgresql"
}

enum UserRole {
    ADMIN
    USER
    HOST
    VENDOR
    GUIDE
}

enum Gender {
    MALE
    FEMALE
    OTHER
}

enum AuthProvider {
    OTP
    PASSWORD
    GOOGLE
}

enum ProviderStatus {
    PENDING
    ACTIVE
    SUSPENDED
    NOT_ACTIVE
}

enum ProviderType {
    TOUR_VENDOR
    ACTIVITY_VENDOR
    HOMESTAY_HOST
    VEHICLE_PARTNER
    LOCAL_GUIDE
    ILP_VENDOR
}

enum BookingSource {
    ONLINE
    OFFLINE
}

enum BookingStatus {
    REQUESTED
    REJECTED
    AWAITING_PAYMENT
    CONFIRMED
    CANCELLED
    COMPLETED
    REFUNDED
    PAYMENT_FAILED
    EXPIRED
}

enum VehicleType {
    BIKE
    SCOOTY
    CAR
    SUV
    TEMPO
}

enum VehicleBookingMode {
    SELF_DRIVE
    WITH_DRIVER
}

enum PaymentProvider {
    RAZORPAY
    STRIPE
}

enum PaymentStatus {
    CREATED
    AUTHORIZED
    CAPTURED
    FAILED
    REFUNDED
}

enum PermitStatus {
    REQUIRED
    COLLECTING_DOCS
    SUBMITTED
    APPROVED
    REJECTED
    EXPIRED
}

enum PermitDocumentType {
    PASSPORT_PHOTO
    ID_PROOF
    SIGNATURE
}

enum RefundStatus {
    INITIATED
    PROCESSED
    FAILED
}

enum PayoutStatus {
    PENDING
    PAID
    FAILED
}

enum MethodEnum {
    CARD
    UPI
    NETBANKING
    WALLET
}

enum BucketListStatus {
    DRAFT
    PENDING_CHECKOUT
    CONVERTED_TO_BOOKING
    EXPIRED
}

enum TourType {
    TOUR
    TREK
}

enum BookingCriteria {
    PER_PERSON
    PER_NIGHT
    HYBRID
}

enum DocumentType {
    PASSPORT
    ID_PROOF
    PERMIT
}

enum ConfigType {
    HOME_PAGE
}

// ─────────────────────────────────────────────
// Address
// Stores PostGIS location and raw address fields with coordinates
// ─────────────────────────────────────────────
model Address {
    id         String                                @id @default(uuid())
    street     String?
    city       String
    state      String
    country    String                                @default("India")
    postalCode String?
    latitude   Float
    longitude  Float
    location   Unsupported("geography(Point,4326)")?
    createdAt  DateTime                              @default(now()) @map("created_at")
    updatedAt  DateTime                              @default(now()) @updatedAt @map("updated_at")

    tours       Tour[]
    homestays   Homestay[]
    pois        POI[]
    vehicles    Vehicle[]
    localGuides LocalGuide[]

    @@unique([latitude, longitude])
}

// ─────────────────────────────────────────────
// POI — Point of Interest
// ─────────────────────────────────────────────
model POI {
    id          String   @id @default(uuid())
    name        String
    description String?
    specialty   String[]
    imageUrls   String[]
    latitude    Float
    longitude   Float
    addressId   String?
    createdAt   DateTime @default(now()) @map("created_at")
    updatedAt   DateTime @default(now()) @updatedAt @map("updated_at")

    address            Address?           @relation(fields: [addressId], references: [id])
    tourItineraryItems TourItineraryPOI[]

    @@index([addressId])
}

// ─────────────────────────────────────────────
// BucketList
// ─────────────────────────────────────────────
model BucketList {
    id        String           @id @default(uuid())
    userId    String
    tripName  String?
    status    BucketListStatus @default(DRAFT)
    createdAt DateTime         @default(now()) @map("created_at")
    updatedAt DateTime         @default(now()) @updatedAt @map("updated_at")

    user  User             @relation(fields: [userId], references: [id], onDelete: Cascade)
    items BucketListItem[]

    @@index([userId, status])
}

// ─────────────────────────────────────────────
// BucketListItem
// ─────────────────────────────────────────────
model BucketListItem {
    id           String       @id @default(uuid())
    bucketListId String
    productType  ProviderType
    tourId       String?
    homestayId   String?
    quantity     Int          @default(1)
    startDate    DateTime?
    endDate      DateTime?
    metadata     Json?
    createdAt    DateTime     @default(now()) @map("created_at")

    tour       Tour?      @relation(fields: [tourId], references: [id])
    homestay   Homestay?  @relation(fields: [homestayId], references: [id])
    bucketList BucketList @relation(fields: [bucketListId], references: [id], onDelete: Cascade)

    @@index([tourId])
    @@index([homestayId])
    @@index([bucketListId])
}

// ─────────────────────────────────────────────
// Vehicle — Not for V1
// ─────────────────────────────────────────────
model Vehicle {
    id              String      @id @default(uuid())
    name            String
    type            VehicleType
    brand           String?
    model           String?
    registrationNo  String      @unique
    imageUrls       String[]
    basePricePerDay Int
    isActive        Boolean     @default(true)
    providerId      String
    addressId       String?
    createdAt       DateTime    @default(now()) @map("created_at")
    updatedAt       DateTime    @default(now()) @updatedAt @map("updated_at")

    bookingMode VehicleBookingMode[]
    provider    Provider             @relation(fields: [providerId], references: [id])
    address     Address?             @relation(fields: [addressId], references: [id])

    @@index([providerId])
    @@index([addressId])
}

// ─────────────────────────────────────────────
// LocalGuide
// ─────────────────────────────────────────────
model LocalGuide {
    id              String   @id @default(uuid())
    providerId      String
    bio             String?
    languages       String[]
    specialties     String[]
    basePricePerDay Int
    imageUrls       String[]
    rating          Float?   @default(0)
    totalReviews    Int      @default(0)
    isActive        Boolean  @default(true)
    addressId       String?
    createdAt       DateTime @default(now()) @map("created_at")
    updatedAt       DateTime @default(now()) @updatedAt @map("updated_at")

    provider Provider @relation(fields: [providerId], references: [id])
    address  Address? @relation(fields: [addressId], references: [id])
    tours    Tour[]

    @@index([providerId])
    @@index([addressId])
}

// ─────────────────────────────────────────────
// Permit
// ─────────────────────────────────────────────
model Permit {
    id               String       @id @default(uuid())
    bookingItemId    String?
    participantId    String?      @unique
    status           PermitStatus @default(REQUIRED)
    passportPhotoId  String?
    identityProofId  String?
    permitDocumentId String?
    submittedAt      DateTime?
    approvedAt       DateTime?
    rejectedAt       DateTime?
    rejectionReason  String?
    createdAt        DateTime     @default(now()) @map("created_at")
    updatedAt        DateTime     @default(now()) @updatedAt @map("updated_at")

    participant    BookingGuest? @relation(fields: [participantId], references: [id])
    bookingItem    BookingItem?  @relation(fields: [bookingItemId], references: [id])
    permitDocument Document?     @relation("PermitDocument", fields: [permitDocumentId], references: [id])
    identityProof  Document?     @relation("IdentityProof", fields: [identityProofId], references: [id])
    passportPhoto  Document?     @relation("PassportPhoto", fields: [passportPhotoId], references: [id])

    @@index([bookingItemId])
    @@index([status, updatedAt(sort: Desc)])
    @@index([participantId])
}

// ─────────────────────────────────────────────
// User
// ─────────────────────────────────────────────
model User {
    id                      String    @id @default(uuid())
    email                   String    @unique
    firstName               String
    lastName                String
    status                  String?   @db.Text
    passwordHash            String?
    isVerified              Boolean   @default(false)
    isOnline                Boolean   @default(false)
    isDisabled              Boolean   @default(false)
    avatarUrl               String?
    gender                  Gender?
    phoneNumber             String?
    dateOfBirth             DateTime?
    timezone                String?
    notificationPreferences Json?
    isDeleted               Boolean   @default(false)
    deletedAt               DateTime?
    lastLogin               DateTime?
    lastSeen                DateTime?
    customerId              String?
    oneTimePassword         String?
    oneTimeExpire           DateTime?
    resetToken              String?
    resetTokenExpire        DateTime?
    createdAt               DateTime  @default(now()) @map("created_at")
    updatedAt               DateTime  @default(now()) @updatedAt @map("updated_at")

    provider       Provider?
    roles          UserRoleMap[]
    sessions       Session[]
    authIdentities AuthIdentity[]
    bookings       Booking[]
    reviews        Review[]
    memories       Memories[]
    bucketLists    BucketList[]
    documents      Document[]

    @@index([email, isVerified])
    @@index([isDisabled, isVerified])
    @@index([isDeleted])
    @@index([isDeleted, createdAt])
}

model UserRoleMap {
    id     String   @id @default(uuid())
    userId String
    role   UserRole

    user User @relation(fields: [userId], references: [id], onDelete: Cascade)

    @@unique([userId, role])
}

model AuthIdentity {
    id         String       @id @default(uuid())
    userId     String
    provider   AuthProvider
    providerId String

    user User @relation(fields: [userId], references: [id], onDelete: Cascade)

    @@unique([provider, providerId])
}

model Session {
    id           String   @id @default(uuid())
    userId       String
    refreshToken String
    expiresAt    DateTime

    user User @relation(fields: [userId], references: [id], onDelete: Cascade)

    @@unique([refreshToken])
    @@index([userId, expiresAt])
}

model Onboarding {
    id           String         @id @default(uuid())
    providerType ProviderType[]
    email        String
    token        String         @unique
    expiresAt    DateTime
    completedAt  DateTime?
    providerId   String?
    metadata     Json?
    createdAt    DateTime       @default(now()) @map("created_at")
    updatedAt    DateTime       @default(now()) @updatedAt @map("updated_at")

    provider Provider? @relation(fields: [providerId], references: [id])

    @@index([token])
    @@index([email])
    @@index([token, expiresAt])
}

// ─────────────────────────────────────────────
// Provider
// ─────────────────────────────────────────────
model Provider {
    id            String         @id @default(uuid())
    name          String
    type          ProviderType[]
    verified      Boolean        @default(false)
    status        ProviderStatus @default(PENDING)
    contactNumber String
    userId        String         @unique
    createdAt     DateTime       @default(now()) @map("created_at")
    updatedAt     DateTime       @default(now()) @updatedAt @map("updated_at")

    user        User             @relation(fields: [userId], references: [id])
    tours       Tour[]
    activities  Activity[]
    homestays   Homestay[]
    vehicles    Vehicle[]
    localGuides LocalGuide[]
    payouts     ProviderPayout[]
    onboardings Onboarding[]

    @@index([status, verified])
}

// ─────────────────────────────────────────────
// Review
//
// NOTE on @@unique: Postgres treats NULL != NULL in unique indexes,
// so @@unique([userId, targetType, tourId, homestayId]) will NOT
// prevent a user from leaving two reviews for the same tour if
// homestayId is NULL both times — the DB sees them as distinct.
// Enforce the one-review-per-product rule in your service layer,
// or use a partial unique index per type in a raw migration:
//
//   CREATE UNIQUE INDEX uq_review_user_tour
//     ON "Review" ("userId", "tourId")
//     WHERE "tourId" IS NOT NULL;
//
//   CREATE UNIQUE INDEX uq_review_user_homestay
//     ON "Review" ("userId", "homestayId")
//     WHERE "homestayId" IS NOT NULL;
//
// DB-level check constraint (add to migration SQL):
//   ALTER TABLE "Review" ADD CONSTRAINT chk_review_one_target
//     CHECK (
//       (tour_id IS NOT NULL AND homestay_id IS NULL) OR
//       (tour_id IS NULL AND homestay_id IS NOT NULL)
//     );
// ─────────────────────────────────────────────
model Review {
    id         String       @id @default(uuid())
    userId     String
    targetType ProviderType
    tourId     String?
    homestayId String?
    rating     Int          @db.SmallInt // 1-5
    comment    String?      @db.Text
    bookingId  String?
    createdAt  DateTime     @default(now()) @map("created_at")
    updatedAt  DateTime     @default(now()) @updatedAt @map("updated_at")

    booking  Booking?  @relation(fields: [bookingId], references: [id])
    user     User      @relation(fields: [userId], references: [id], onDelete: Cascade)
    tour     Tour?     @relation(fields: [tourId], references: [id])
    homestay Homestay? @relation(fields: [homestayId], references: [id])

    // See note above — enforce uniqueness via partial indexes in migration SQL
    @@index([tourId, rating(sort: Desc)])
    @@index([homestayId, rating(sort: Desc)])
    @@index([userId])
    @@index([rating])
}

// ─────────────────────────────────────────────
// Tag
// ─────────────────────────────────────────────
model Tag {
    id        String   @id @default(uuid())
    label     String   @unique
    color     String
    icon      String?
    category  String? // "tour", "homestay", "activity"
    createdAt DateTime @default(now()) @map("created_at")
    updatedAt DateTime @default(now()) @updatedAt @map("updated_at")

    tours     TourTag[]
    homestays HomestayTag[]
}

model TourTag {
    tourId String
    tagId  String
    tour   Tour   @relation(fields: [tourId], references: [id], onDelete: Cascade)
    tag    Tag    @relation(fields: [tagId], references: [id])

    @@id([tourId, tagId])
}

model HomestayTag {
    homestayId String
    tagId      String
    homestay   Homestay @relation(fields: [homestayId], references: [id], onDelete: Cascade)
    tag        Tag      @relation(fields: [tagId], references: [id])

    @@id([homestayId, tagId])
}

// ─────────────────────────────────────────────
// Facility
// ─────────────────────────────────────────────
model Facility {
    id          String   @id @default(uuid())
    name        String   @unique
    icon        String
    description String?
    category    String?
    createdAt   DateTime @default(now()) @map("created_at")
    updatedAt   DateTime @default(now()) @updatedAt @map("updated_at")

    homestays HomestayFacility[]
}

model HomestayFacility {
    homestayId String
    facilityId String
    homestay   Homestay @relation(fields: [homestayId], references: [id], onDelete: Cascade)
    facility   Facility @relation(fields: [facilityId], references: [id])

    @@id([homestayId, facilityId])
}

// ─────────────────────────────────────────────
// Tour Itinerary
// ─────────────────────────────────────────────
model TourItinerary {
    id        String @id @default(uuid())
    tourId    String
    dayNumber Int
    title     String
    details   Json?

    tour Tour               @relation(fields: [tourId], references: [id], onDelete: Cascade)
    pois TourItineraryPOI[]

    @@unique([tourId, dayNumber]) // prevent duplicate day entries per tour
    @@index([tourId])
}

model TourItineraryPOI {
    id          String @id @default(uuid())
    itineraryId String
    poiId       String
    order       Int

    itinerary TourItinerary @relation(fields: [itineraryId], references: [id], onDelete: Cascade)
    poi       POI           @relation(fields: [poiId], references: [id], onDelete: Cascade)

    @@unique([itineraryId, poiId, order])
    @@index([itineraryId])
    @@index([poiId])
}

// ─────────────────────────────────────────────
// Tour
// NOTE: finalPrice is a stored computed field (basePrice - discount%).
// Always update it together with basePrice/discount in your service layer
// to prevent drift.
// ─────────────────────────────────────────────
model Tour {
    id           String   @id @default(uuid())
    title        String
    description  String
    type         TourType @default(TOUR)
    basePrice    Int // Original price
    discount     Int      @default(0) // Percentage discount (0-100)
    finalPrice   Int // Actual selling price — keep in sync with basePrice/discount
    duration     Int // In days
    imageUrls    String[]
    maxCapacity  Int      @default(10)
    rating       Float?   @default(0)
    totalReviews Int      @default(0)
    isActive     Boolean  @default(true)
    about        String?
    included     String[]
    notIncluded  String[]
    highlights   String[]
    brochure     String?
    addressId    String?
    providerId   String?
    guideId      String?
    createdAt    DateTime @default(now()) @map("created_at")
    updatedAt    DateTime @default(now()) @updatedAt @map("updated_at")

    guide           LocalGuide?      @relation(fields: [guideId], references: [id])
    address         Address?         @relation(fields: [addressId], references: [id])
    provider        Provider?        @relation(fields: [providerId], references: [id])
    reviews         Review[]
    tags            TourTag[]
    itinerary       TourItinerary[]
    bucketListItems BucketListItem[]

    @@index([providerId])
    @@index([isActive, rating])
    @@index([addressId])
}

// ─────────────────────────────────────────────
// Activity — Not for V1
// ─────────────────────────────────────────────
model Activity {
    id          String   @id @default(uuid())
    title       String
    description String
    price       Int
    duration    Int
    providerId  String
    createdAt   DateTime @default(now()) @map("created_at")
    updatedAt   DateTime @default(now()) @updatedAt @map("updated_at")

    provider Provider @relation(fields: [providerId], references: [id])

    @@index([providerId])
}

// ─────────────────────────────────────────────
// Homestay
// NOTE: bookingCriteria exists on both Homestay and HomestayRoom.
// HomestayRoom-level takes precedence; the Homestay-level field is
// a display default only. Enforce this clearly in your service layer.
// ─────────────────────────────────────────────
model Homestay {
    id              String          @id @default(uuid())
    name            String
    description     String
    houseRules      String[]
    safetyNSecurity String[]
    imageUrls       String[]
    displayPrice    Int? // "Starting from ₹X" for UI
    rating          Float?          @default(0)
    totalReviews    Int             @default(0)
    bookingCriteria BookingCriteria @default(PER_NIGHT) // display default; room-level overrides
    email           String
    phoneNumber     String
    isActive        Boolean         @default(true)
    providerId      String
    addressId       String?
    createdAt       DateTime        @default(now()) @map("created_at")
    updatedAt       DateTime        @default(now()) @updatedAt @map("updated_at")

    address         Address?           @relation(fields: [addressId], references: [id])
    provider        Provider           @relation(fields: [providerId], references: [id])
    reviews         Review[]
    facilities      HomestayFacility[]
    tags            HomestayTag[]
    rooms           HomestayRoom[]
    bucketListItems BucketListItem[]

    @@index([providerId])
    @@index([addressId])
    @@index([isActive, rating])
}

// ─────────────────────────────────────────────
// HomestayRoom
// ─────────────────────────────────────────────
model HomestayRoom {
    id              String          @id @default(uuid())
    homestayId      String
    name            String
    description     String?
    capacity        Int
    basePrice       Int
    discount        Int             @default(0)
    finalPrice      Int // Actual selling price — keep in sync with basePrice/discount
    bookingCriteria BookingCriteria @default(PER_NIGHT)
    totalRooms      Int
    amenities       String[]
    imageUrls       String[]
    isActive        Boolean         @default(true)
    createdAt       DateTime        @default(now()) @map("created_at")
    updatedAt       DateTime        @default(now()) @updatedAt @map("updated_at")

    homestay     Homestay           @relation(fields: [homestayId], references: [id])
    availability RoomAvailability[]
    bookings     RoomBooking[]

    @@index([homestayId, isActive])
}

// ─────────────────────────────────────────────
// RoomAvailability
// NOTE: date is stored as DateTime. To avoid timezone bugs, always
// normalize to UTC midnight (00:00:00Z) before writing, or use a
// raw @db.Date column in a future migration.
// ─────────────────────────────────────────────
model RoomAvailability {
    id        String   @id @default(uuid())
    roomId    String
    date      DateTime @db.Date // FIXED: using Date type to prevent timezone drift
    available Int
    price     Int? // Optional: allow per-date pricing override

    room HomestayRoom @relation(fields: [roomId], references: [id])

    @@unique([roomId, date])
    @@index([roomId, date(sort: Desc)])
}

model RoomBooking {
    id              String   @id @default(uuid())
    bookingItemId   String   @unique // One room booking per booking item
    roomId          String
    checkIn         DateTime
    checkOut        DateTime
    guests          Int
    specialRequests String?  @db.Text
    createdAt       DateTime @default(now()) @map("created_at")
    updatedAt       DateTime @default(now()) @updatedAt @map("updated_at")

    room        HomestayRoom @relation(fields: [roomId], references: [id])
    bookingItem BookingItem  @relation(fields: [bookingItemId], references: [id], onDelete: Cascade)

    @@index([roomId, checkIn, checkOut])
    @@index([checkIn, checkOut])
}

// ─────────────────────────────────────────────
// Destination — Not for V1
// ─────────────────────────────────────────────
model Destination {
    id          String   @id @default(uuid())
    name        String
    description String
    imageUrls   String[]
    tripPrice   Int
    noOfDays    Int[]
    tags        String[]
    latitude    Float
    longitude   Float
    address     String
    createdAt   DateTime @default(now()) @map("created_at")
    updatedAt   DateTime @default(now()) @updatedAt @map("updated_at")
}

// ─────────────────────────────────────────────
// Booking
// ─────────────────────────────────────────────
model Booking {
    id                 String        @id @default(uuid())
    userId             String
    status             BookingStatus
    source             BookingSource @default(ONLINE)
    totalAmount        Int?
    paidAmount         Int?
    confirmedAt        DateTime?
    cancelledAt        DateTime?
    cancellationReason String?
    completedAt        DateTime?
    expiresAt          DateTime? // Payment expiry for AWAITING_PAYMENT
    metadata           Json?
    createdAt          DateTime      @default(now()) @map("created_at")
    updatedAt          DateTime      @default(now()) @updatedAt @map("updated_at")

    user    User          @relation(fields: [userId], references: [id])
    reviews Review[]
    payment Payment[]
    items   BookingItem[]

    @@index([userId, status, createdAt(sort: Desc)])
    @@index([status, expiresAt])
    @@index([createdAt])
}

// ─────────────────────────────────────────────
// BookingItem
// NOTE: productType + productId are kept for fast querying/filtering.
// There are no Prisma-level FK relations to Tour/Homestay here by
// design — resolution is handled in the service layer.
// totalAmount = finalPrice * quantity. Keep in sync on every write.
// ─────────────────────────────────────────────
model BookingItem {
    id             String       @id @default(uuid())
    bookingId      String
    productType    ProviderType
    productId      String
    startDate      DateTime?
    endDate        DateTime?
    quantity       Int
    basePrice      Int // Original unit price (snapshot at time of booking)
    discount       Int // Discount applied (%)
    finalPrice     Int // Actual unit price charged
    totalAmount    Int // finalPrice * quantity — keep in sync
    permitRequired Boolean      @default(false)
    metadata       Json?

    booking Booking          @relation(fields: [bookingId], references: [id], onDelete: Cascade)
    guests  BookingGuest[]
    rooms   RoomBooking?
    permits Permit[]
    payouts ProviderPayout[]

    @@index([bookingId])
    @@index([productType, productId])
}

model BookingGuest {
    id            String    @id @default(uuid())
    bookingItemId String
    fullName      String
    email         String?
    age           Int
    contactNumber String
    gender        Gender
    dateOfArrival DateTime?
    createdAt     DateTime  @default(now()) @map("created_at")
    updatedAt     DateTime  @default(now()) @updatedAt @map("updated_at")

    permit      Permit?
    bookingItem BookingItem @relation(fields: [bookingItemId], references: [id], onDelete: Cascade)

    @@index([bookingItemId])
}

model TemporaryUpload {
    id             String    @id @default(uuid())
    userId         String?
    sessionId      String? // For non-authenticated users
    s3Key          String    @unique
    s3Bucket       String
    fileName       String
    mimeType       String
    size           Int?
    uploadedAt     DateTime  @default(now())
    expiresAt      DateTime
    associatedWith String? // "booking", "permit", "onboarding"
    referenceId    String?
    isUsed         Boolean   @default(false)
    deletedAt      DateTime?
    createdAt      DateTime  @default(now()) @map("created_at")

    @@index([expiresAt, deletedAt])
    @@index([userId, associatedWith])
    @@index([sessionId, expiresAt])
    @@index([isUsed, expiresAt])
}

model Payment {
    id                String          @id @default(uuid())
    amount            Int
    currency          String          @default("INR")
    status            PaymentStatus
    provider          PaymentProvider
    providerOrderId   String?         @unique
    providerPaymentId String?         @unique
    notes             String?         @db.Text
    method            MethodEnum?
    cardToken         String?
    cardLast4         String?
    cardNetwork       String?
    cardBank          String?
    upiVpa            String?
    upiName           String?
    bankCode          String?
    bankName          String?
    nickname          String?
    bookingId         String?
    failureReason     String?
    capturedAt        DateTime?
    failedAt          DateTime?
    createdAt         DateTime        @default(now()) @map("created_at")
    updatedAt         DateTime        @default(now()) @updatedAt @map("updated_at")

    booking Booking?         @relation(fields: [bookingId], references: [id])
    refunds Refund[]
    payouts ProviderPayout[]
    webhook WebhookEvent[]

    @@index([bookingId, status])
    @@index([status])
    @@index([providerOrderId])
}

model Refund {
    id               String       @id @default(uuid())
    paymentId        String
    amount           Int
    reason           String?      @db.Text
    status           RefundStatus
    providerRefundId String?      @unique
    processedAt      DateTime?
    failedAt         DateTime?
    failureReason    String?
    createdAt        DateTime     @default(now()) @map("created_at")
    updatedAt        DateTime     @default(now()) @updatedAt @map("updated_at")

    payment Payment @relation(fields: [paymentId], references: [id])

    @@index([paymentId])
    @@index([status])
}

// ─────────────────────────────────────────────
// ProviderPayout
// ─────────────────────────────────────────────
model ProviderPayout {
    id            String       @id @default(uuid())
    providerId    String
    bookingItemId String
    paymentId     String?
    amount        Int
    platformFee   Int          @default(0) // optional: track your cut
    netAmount     Int // amount - platformFee
    periodStart   DateTime
    periodEnd     DateTime
    status        PayoutStatus
    createdAt     DateTime     @default(now()) @map("created_at")
    updatedAt     DateTime     @default(now()) @updatedAt @map("updated_at")

    bookingItem BookingItem @relation(fields: [bookingItemId], references: [id])
    payment     Payment?    @relation(fields: [paymentId], references: [id])
    provider    Provider    @relation(fields: [providerId], references: [id])

    @@index([providerId, status, createdAt(sort: Desc)])
    @@index([bookingItemId])
}

// ─────────────────────────────────────────────
// CancellationPolicy
// ─────────────────────────────────────────────
model CancellationPolicy {
    id          String       @id @default(uuid())
    productType ProviderType
    productId   String
    hoursBefore Int
    refundPct   Int
    createdAt   DateTime     @default(now()) @map("created_at")
    updatedAt   DateTime     @default(now()) @updatedAt @map("updated_at")

    @@unique([productId, productType])
}

model WebhookEvent {
    id              String          @id @default(uuid())
    provider        PaymentProvider
    providerEventId String          @unique
    eventType       String
    receivedAt      DateTime        @default(now())
    signature       String?
    rawBody         Json
    processed       Boolean         @default(false)
    processedAt     DateTime?
    notes           String?
    paymentId       String?
    createdAt       DateTime        @default(now()) @map("created_at")
    updatedAt       DateTime        @default(now()) @updatedAt @map("updated_at")

    payment Payment? @relation(fields: [paymentId], references: [id], onDelete: Cascade)

    @@index([eventType])
    @@index([paymentId])
}

// ─────────────────────────────────────────────
// Document
// ─────────────────────────────────────────────
model Document {
    id           String       @id @default(uuid())
    userId       String?
    type         DocumentType
    url          String // Full S3 URL
    s3Key        String?
    s3Bucket     String?
    fileName     String?
    mimeType     String?
    size         Int?
    uploadedAt   DateTime     @default(now())
    deletedAt    DateTime?
    tempUploadId String?
    createdAt    DateTime     @default(now()) @map("created_at")
    updatedAt    DateTime     @default(now()) @updatedAt @map("updated_at")

    user              User?    @relation(fields: [userId], references: [id])
    permitsAsPassport Permit[] @relation("PassportPhoto")
    permitsAsIdentity Permit[] @relation("IdentityProof")
    permitsAsDocument Permit[] @relation("PermitDocument")

    @@index([userId, type])
    @@index([deletedAt])
    @@index([s3Key])
    @@index([tempUploadId])
}

model ServiceWaitlist {
    id          String       @id @default(uuid())
    email       String
    name        String?
    phoneNumber String?
    serviceType ProviderType
    location    String?
    notified    Boolean      @default(false)
    notifiedAt  DateTime?
    metadata    Json?
    createdAt   DateTime     @default(now()) @map("created_at")
    updatedAt   DateTime     @default(now()) @updatedAt @map("updated_at")

    @@unique([email, serviceType])
    @@index([serviceType, notified])
}

model CommunityJoinRequest {
    id          String    @id @default(uuid())
    fullName    String
    email       String    @unique
    phoneNumber String
    location    String?
    interests   String[]
    message     String?   @db.Text
    contacted   Boolean   @default(false)
    contactedAt DateTime?
    notes       String?   @db.Text
    createdAt   DateTime  @default(now()) @map("created_at")
    updatedAt   DateTime  @default(now()) @updatedAt @map("updated_at")

    @@index([contacted])
    @@index([createdAt])
}

model FeatureFlag {
    id          String       @id @default(uuid())
    serviceType ProviderType @unique
    enabled     Boolean      @default(true)
    message     String?
    createdAt   DateTime     @default(now()) @map("created_at")
    updatedAt   DateTime     @default(now()) @updatedAt @map("updated_at")

    @@index([serviceType, enabled])
}

// ─────────────────────────────────────────────
// AppBanner — Not for V1
// FIX #6: Renamed imageUrl -> imageUrls to match naming convention
// ─────────────────────────────────────────────
model AppBanner {
    id        String   @id @default(uuid())
    name      String
    imageUrls String[] // FIX: was imageUrl (inconsistent with rest of schema)
    redirect  String
    createdAt DateTime @default(now()) @map("created_at")
    updatedAt DateTime @default(now()) @updatedAt @map("updated_at")
}

// ─────────────────────────────────────────────
// AppUiConfig — Not for V1
// ─────────────────────────────────────────────
model AppUiConfig {
    id        String     @id @default(uuid())
    name      String
    type      ConfigType @default(HOME_PAGE)
    uiConfig  Json
    createdAt DateTime   @default(now()) @map("created_at")
    updatedAt DateTime   @default(now()) @updatedAt @map("updated_at")
}

// ─────────────────────────────────────────────
// Memories — Not for V1
// ─────────────────────────────────────────────
model Memories {
    id          String   @id @default(uuid())
    title       String
    description String?
    imageUrls   String[]
    userId      String
    createdAt   DateTime @default(now()) @map("created_at")
    updatedAt   DateTime @default(now()) @updatedAt @map("updated_at")

    user User @relation(fields: [userId], references: [id])
}
